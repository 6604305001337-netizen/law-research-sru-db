<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบฐานข้อมูลวิจัย - คณะนิติศาสตร์ มรส.</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- COLOR PALETTE --- */
        :root {
            --law-maroon: #800000;
            --law-maroon-deep:#5a0000;
            --law-gold: #D4AF37;
            --law-gold-bright:  #F4D03F;
            --bg-cream: #f9f1f1;
            --text-dark: #2d2d2d;
            --text-muted: #666666;
        }


        :root {
            --law-maroon: #800000;
            --law-maroon-deep: #4a0000;
            --law-gold: #D4AF37;
            --law-gold-light: #F1E5AC;
        }

        /* ตกแต่งปุ่มย้อนกลับให้มีความนูนและเงา */
        .btn-back-premium {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .btn-back-premium:hover {
            background: #e11d48; /* สีแดงสว่างเมื่อชี้ */
            transform: translateX(-5px);
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
        }

        /* การ์ดงานวิจัยแบบพรีเมียม */
        .research-card-inner {
            border-left: 5px solid var(--law-gold);
            transition: all 0.3s transform;
        }
        .research-card-inner:hover {
            transform: scale(1.02);
            border-left-width: 10px;
        }


        body { 
            font-family: 'Kanit ExtraLight', sans-serif; 
            background-color: var(--bg-cream);
            color: var(--text-dark);
            position: relative;
        }

        /* --- TRANSPARENT WATERMARK --- */
        body::before, .modal-watermark::before {
            content: "";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-image: url('logo.png'); /* Ensure this path is correct */
            background-repeat: no-repeat;
            background-position: center center;
            pointer-events: none;
            z-index: -1;
        }
        body::before {
            width: 80%; height: 80%;
            background-size: contain;
            opacity: 0.03;
            filter: grayscale(100%);
            position: fixed;
        }
        .modal-watermark { position: relative; overflow: hidden; }
        .modal-watermark::before {
            width: 60%; height: 60%;
            background-size: contain;
            opacity: 0.05;
        }
        .modal-content-relative { position: relative; z-index: 5; }

        /* --- HEADER --- */
        .majestic-header {
             background: linear-gradient(135deg, var(--law-maroon-deep) 20%, var(--law-maroon) 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(128, 0, 0, 0.3);
            border-bottom: 4px solid var(--law-gold);
               /* ขอบทองหนาและสว่าง */
            border-bottom: 6px solid var(--law-gold);
            position: sticky;
            top: 0;
            z-index: 100;
            /* เพิ่มความสูง (Padding) ให้กว้างขึ้นตามสั่ง */
            padding: 1.25rem 0; 
        }

       /* กรอบโลโก้เรืองแสง */
        .logo-frame-glow {
            background: rgb(255, 255, 255);
            padding: 8px;
            border-radius: 1rem;
            /* สร้างเอฟเฟกต์เรืองแสงสีทอง */
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.7);
            border: 3px solid var(--law-gold-bright);
            display: flex; align-items: center; justify-content: center;
        }
 /* Badge สวยๆ */
        .badge-maroon { background: var(--law-maroon); color: white; }
        .badge-gold { background: var(--law-gold-bright); color: var(--law-maroon-dark); font-weight: bold; }
        /* --- BUTTONS & BADGES --- */

        .btn-gold-premium {
            background: linear-gradient(135deg, var(--law-gold), #c59d2e);
            color: #4a0000;
            font-weight: 700;
            box-shadow: 0.5px 15px rgba(212, 175, 55, 0.4);
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            border: 2px solid white;
        }
        .btn-gold-premium:hover {
            transform: translateY(1.05px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
            color: #2a0000;
        }
        .badge-maroon { background-color: var(--law-maroon); color: white; }
        .badge-gold { background-color: var(--law-gold); color: var(--law-maroon); font-weight: 600; }

        /* --- CONTENT CARDS --- */
        .content-card-premium {
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border-radius: 1.5rem;
            border: 1px solid rgba(212, 175, 55, 0.15);
            overflow: hidden;
        }
        .research-item-premium {
            transition: all 0.3s ease;
            border-left: 8px solid var(--law-maroon);
            background: white;
        }
        .research-item-premium:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            border-left-color: var(--law-gold);
        }

        /* --- FORM ELEMENTS --- */
        input[type="text"], input[type="number"], select, textarea {
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            background-color: #fdfdfd;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border-color: var(--law-gold);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
            background-color: white;
        }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; padding: 1rem; }
        
        /* Image 2: View Modal Styling */
        #viewModal .bg-law-maroon {
            background: linear-gradient(135deg, var(--law-maroon), #600000);
            border-bottom: 3px solid var(--law-gold);
        }
        #viewModal .modal-content-relative > div {
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.05);
        }
        #viewModal .bg-red-50 { background: linear-gradient(to bottom right, #fff5f5, #ffecec); border-color: #fecaca; }
        #viewModal .bg-green-50 { background: linear-gradient(to bottom right, #f0fdf4, #dcfce7); border-color: #bbf7d0; }
        #viewModal .bg-blue-50 { background: linear-gradient(to bottom right, #eff6ff, #dbeafe); border-color: #bfdbfe; }

        /* Image 3: Add/Edit Modal Styling */
        #addModal .bg-law-maroon {
            background: linear-gradient(to right, var(--law-maroon), var(--law-maroon-light));
        }
        #addModal h3 {
            color: var(--law-gold);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        #addModal .modal-content-relative {
            /* Subtle law-themed background pattern */
            background-color: #ffffff;
            background-image: radial-gradient(var(--law-gold-light) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -19px -19px;
        }
        #addModal label span.text-red-500 { color: var(--law-maroon); }
        #addModal .bg-red-50\/80 {
            background: linear-gradient(to bottom right, rgba(255, 245, 245, 0.9), rgba(255, 236, 236, 0.9));
            border: 2px solid rgba(128, 0, 0, 0.1);
        }

        /* --- DASHBOARD SUMMARY CARDS (Image 1) --- */
        #summaryDashboard > div {
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0,0,0,0.03);
            background: white;
            position: relative;
            overflow: hidden;
        }
        #summaryDashboard > div:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }
        /* The "All Works" card (circled in red) */
        #summaryDashboard > div:first-child {
            background: linear-gradient(135deg, var(--law-maroon), var(--law-maroon-light));
            color: white;
            border: none;
            box-shadow: 0 10px 25px rgba(128, 0, 0, 0.3);
        }
        #summaryDashboard > div:first-child p:first-child { opacity: 0.8; color: var(--law-gold); }
        #summaryDashboard > div:first-child p:nth-child(2) { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #summaryDashboard > div:first-child::after {
            content: "";
            position: absolute;
            top: -20%; right: -20%;
            width: 150px; height: 150px;
            background: var(--law-gold);
            opacity: 0.1;
            border-radius: 50%;
        }
        /* Other summary cards */
        #summaryDashboard > div:not(:first-child) p:first-child {
            color: var(--law-maroon); font-weight: 600; display: flex; align-items: center; gap: 0.5rem;
        }
        #summaryDashboard > div:not(:first-child) p:nth-child(2) {
            color: var(--text-dark);
        }
        #summaryDashboard > div:not(:first-child)::before {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px;
            background: var(--law-gold);
            opacity: 0.5;
        }
        .badge-maroon { background-color: var(--law-maroon); color: white; }
        .badge-gold { background-color: var(--law-gold); color: var(--law-maroon); font-weight: 600; }
        
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); justify-content: center; align-items: center; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--law-gold); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--law-maroon); }
    </style>
</head>
<body>
    <header class="majestic-header">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="logo-frame-glow w-20 h-20 md:w-24 md:h-24 shrink-0">
                    <img src="logo.png" class="h-14 md:h-16 w-auto object-contain" onerror="this.src='https://upload.wikimedia.org/wikipedia/th/a/a2/Suratthani_Rajabhat_University_Logo.png'">
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-white drop-shadow-sm">คณะนิติศาสตร์</h1>
                    <p class="text-sm md:text-base text-law-gold-bright font-medium tracking-[0.2em] uppercase mt-1">Faculty of Law | SRU</p>
                </div>
            </div>
            
            <button onclick="openAddModal()" class="btn-gold-premium flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="hidden sm:inline text-lg">เพิ่มข้อมูลวิจัย</span>
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12 max-w-5xl">
        
        <div id="summaryDashboard" class="grid grid-cols-2 md:grid-cols-4 gap-5 mb-10"></div>

        <div class="content-card-premium p-8 mb-10">
            <div class="flex items-center mb-8">
                <h2 class="text-3xl font-bold text-law-maroon flex items-center gap-3">
                    <i data-lucide="book-marked" class="w-8 h-8 text-law-gold"></i>
                    คลังข้อมูลงานวิจัยและตีพิมพ์
                </h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
                <div class="md:col-span-8">
                    <div class="relative group">
                        <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-law-gold w-6 h-6"></i>
                        <input type="text" id="searchInput" placeholder="ค้นหาชื่อเรื่อง หรือ ชื่อผู้วิจัย..." 
                               class="w-full pl-14 pr-4 py-4 bg-white border-2 border-gray-200 rounded-full focus:border-law-gold focus:ring-4 focus:ring-yellow-100/50 outline-none transition-all text-lg text-gray-700 shadow-sm" onkeyup="filterData()">
                    </div>
                </div>
                <div class="md:col-span-4">
                    <select id="yearFilter" onchange="filterData()" class="w-full p-4 bg-white border-2 border-gray-200 rounded-full outline-none focus:border-law-gold cursor-pointer font-medium text-gray-600 text-lg shadow-sm appearance-none text-center relative">
                        <option value="">ทุกปีงบประมาณ</option>
                        <option value="2570">2570</option><option value="2569">2569</option>
                        <option value="2568">2568</option><option value="2567">2567</option>
                        <option value="2566">2566</option><option value="2565">2565</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="resultsList" class="space-y-5"></div>
    </main>

    <div id="addModal" class="modal px-4">
        <div class="bg-white rounded-[2rem] w-full max-w-2xl overflow-hidden shadow-2xl transform transition-all h-[90vh] overflow-y-auto modal-watermark border-4 border-law-gold">
            <div class="bg-law-maroon p-6 text-white flex justify-between items-center sticky top-0 z-20 border-b-4 border-law-gold-bright">
                <h3 class="text-2xl font-bold flex items-center gap-3 text-white">
                    <i data-lucide="folder-plus" class="text-law-gold-bright w-7 h-7"></i> บันทึกข้อมูลงานวิจัย
                </h3>
                <button onclick="closeModal('addModal')" class="bg-white/10 hover:bg-white/30 p-2 rounded-full transition text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="p-8 grid grid-cols-1 gap-8 modal-content-relative">
                <div>
                    <label class="block text-lg font-bold text-law-maroon mb-3">ชื่อบทความ / โครงการวิจัย <span class="text-red-500">*</span></label>
                    <input type="text" id="addTitle" class="w-full px-5 py-4 bg-white border-2 border-gray-300 rounded-2xl focus:border-law-gold outline-none transition shadow-sm text-lg" placeholder="ระบุชื่อผลงานวิจัยฉบับเต็ม...">
                </div>

                <div class="bg-red-50/80 p-8 rounded-[2rem] border-2 border-law-maroon/30 shadow-inner">
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label class="flex items-center text-lg font-bold text-law-maroon mb-3">
                                <span class="bg-law-maroon text-white p-1 rounded-md mr-2"><i data-lucide="user-check" class="w-5 h-5"></i></span>
                                ผู้วิจัยหลัก <span class="text-red-500 ml-1">*</span>
                            </label>
                            <input type="text" id="addHeadAuthor" class="w-full px-5 py-3 bg-white border-2 border-red-100 rounded-xl focus:border-law-maroon outline-none text-lg" placeholder="ระบุชื่อผู้วิจัยหลัก...">
                        </div>
                        <div>
                            <label class="flex items-center text-lg font-bold text-gray-700 mb-3">
                                <span class="bg-gray-400 text-white p-1 rounded-md mr-2"><i data-lucide="users" class="w-5 h-5"></i></span>
                                ผู้ร่วมวิจัย (ถ้ามี)
                            </label>
                            <textarea id="addCoAuthor" rows="2" class="w-full px-5 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-law-gold outline-none text-lg" placeholder="ระบุชื่อผู้ร่วมวิจัย (คั่นด้วยจุลภาค)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-base font-semibold text-gray-700 mb-2">ปีงบประมาณ</label>
                        <select id="addYear" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-law-gold outline-none text-lg appearance-none">
                            <option value="2570">2570</option><option value="2569">2569</option>
                            <option value="2568" selected>2568</option><option value="2567">2567</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base font-semibold text-gray-700 mb-2">งบประมาณ (บาท)</label>
                        <input type="number" id="addBudget" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-law-gold outline-none text-lg" placeholder="0">
                    </div>
                </div>

                 <div>
                    <label class="block text-base font-semibold text-gray-700 mb-2">ประเภทการตีพิมพ์ (TCI)</label>
                    <select id="addTci" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-law-gold outline-none text-lg appearance-none">
                        <option value="">- ไม่ระบุ -</option>
                        <option value="1">TCI กลุ่ม 1</option><option value="2">TCI กลุ่ม 2</option>
                        <option value="3">TCI กลุ่ม 3</option>
                        <option value="นานาชาติ">นานาชาติ</option><option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>
            <div class="mt-4">
                <label class="block text-base font-semibold text-gray-700 mb-2">แนบไฟล์งานวิจัย (PDF, Word, รูปภาพ)</label>
                <div class="relative">
                    <input type="file" id="addFile" class="hidden" onchange="document.getElementById('fileNameDisplay').innerText = 'เลือกไฟล์แล้ว: ' + this.files[0].name">
                    <label for="addFile" class="flex items-center justify-center gap-3 w-full px-4 py-4 bg-gray-50 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer hover:border-law-gold transition">
                        <i data-lucide="upload-cloud" class="text-gray-400 w-6 h-6"></i>
                        <span id="fileNameDisplay" class="text-gray-500">คลิกเพื่อแนบไฟล์เอกสาร</span>
                    </label>
                </div>
            </div>
                    
                <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-gray-200">
                    <button onclick="closeModal('addModal')" class="px-8 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-full transition">ยกเลิก</button>
                    <button onclick="saveNewData()" id="saveBtn" class="btn-gold-premium flex items-center gap-2 text-xl">
                        <i data-lucide="save" class="w-6 h-6"></i> บันทึกข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal px-4">
        <div class="bg-white rounded-[2rem] w-full max-w-3xl overflow-hidden shadow-2xl modal-watermark border-4 border-law-gold">
            <div id="viewHeader" class="bg-law-maroon text-white p-8 relative border-b-4 border-law-gold-bright">
                <span id="viewYearBadge" class="inline-block px-4 py-1 bg-law-gold-bright text-law-maroon font-extrabold rounded-full mb-4 shadow-sm"></span>
                <h3 id="viewTitle" class="text-3xl font-bold leading-snug modal-content-relative text-white drop-shadow-sm"></h3>
                <button onclick="closeModal('viewModal')" class="absolute top-6 right-6 bg-black/20 hover:bg-black/40 p-2 rounded-full transition z-10 text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-10 modal-content-relative">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-3 bg-red-50 p-6 rounded-3xl border-2 border-law-maroon/20">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-3 bg-law-maroon text-white rounded-full shadow-md"><i data-lucide="users" class="w-6 h-6"></i></div>
                            <h4 class="text-xl font-bold text-law-maroon">คณะผู้วิจัย</h4>
                        </div>
                        <div id="viewAuthorsDetail" class="space-y-3 pl-4 border-l-4 border-law-gold"></div>
                    </div>

                    <div class="bg-green-50 p-6 rounded-3xl border-2 border-green-200">
                        <p class="text-sm font-bold text-green-800 uppercase flex items-center gap-2 mb-2"><i data-lucide="coins" class="w-4 h-4"></i> งบประมาณ</p>
                        <p id="viewBudget" class="text-2xl font-extrabold text-green-700"></p>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-3xl border-2 border-blue-200">
                        <p class="text-sm font-bold text-blue-800 uppercase flex items-center gap-2 mb-2"><i data-lucide="book-open-check" class="w-4 h-4"></i> การตีพิมพ์ (TCI)</p>
                        <p id="viewTci" class="text-xl font-bold text-blue-900"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwDxkePnVgxuzIpFxxS0M0ZvszsbOj1UYSsFzj3O6xioWXFKLw7tU-GvKyA46G8UUc/exec";
        let db = [];
        let selectedFileData = "";
        let isEditMode = false;
        let editIndex = null;

        window.onload = () => { lucide.createIcons(); loadData(); };

        function openAddModal() { 
            isEditMode = false; editIndex = null;
            document.getElementById('addModal').style.display = 'flex'; 
            document.getElementById('saveBtn').innerHTML = '<i data-lucide="save" class="w-6 h-6"></i> บันทึกข้อมูล';
            document.getElementById('addTitle').value = '';
            document.getElementById('addHeadAuthor').value = '';
            document.getElementById('addCoAuthor').value = '';
            document.getElementById('addBudget').value = '';
            document.getElementById('addTci').value = '';
            lucide.createIcons();
        }
        
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function loadData() {
            const list = document.getElementById('resultsList');
            list.innerHTML = `
                <div class="flex flex-col items-center justify-center py-24">
                    <div class="w-16 h-16 border-4 border-law-gold border-t-law-maroon rounded-full animate-spin mb-4"></div>
                    <p class="text-2xl font-bold text-law-maroon animate-pulse">กำลังสืบค้นฐานข้อมูล...</p>
                </div>`;
            try {
                const res = await fetch(API_URL);
                db = await res.json(); 
                renderData(); 
            } catch (e) {
                list.innerHTML = '<div class="text-center py-20 text-red-500 text-xl font-bold">ไม่สามารถเชื่อมต่อฐานข้อมูลได้</div>';
            }
        }

        function renderData(data = db) {
            updateSummary(data); 
            const list = document.getElementById('resultsList');
            list.innerHTML = data.length ? '' : `
                <div class="text-center py-24 bg-white rounded-[3rem] border-4 border-dashed border-gray-100">
                    <p class="text-2xl text-gray-400 font-medium">ไม่พบรายการงานวิจัย</p>
                </div>`;
            
            data.forEach((item, index) => {
                const authors = item.author.split('||');
                const head = authors[0] ? authors[0].trim() : 'ไม่ระบุ';
                const coRaw = (authors[1] && authors[1].trim() !== 'null' && authors[1].trim() !== '') ? authors[1].trim() : null;
                const coAuthors = coRaw ? coRaw.split(',').map(n => n.trim()) : [];

                const html = `
                    <div class="content-card-premium research-item-premium p-8 relative group cursor-pointer" onclick="openViewModal(${index})">
                        <div class="absolute top-6 right-6 flex gap-3 z-20 opacity-0 group-hover:opacity-100 transition-all duration-300">
                            <button onclick="event.stopPropagation(); editItem(${index})" class="p-3 bg-white text-blue-600 hover:bg-blue-600 hover:text-white rounded-2xl shadow-xl border-2 border-blue-50 transition-all transform hover:scale-110"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                            <button onclick="event.stopPropagation(); deleteItem('${item.title}', ${index})" class="p-3 bg-white text-red-600 hover:bg-red-600 hover:text-white rounded-2xl shadow-xl border-2 border-red-50 transition-all transform hover:scale-110"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>

                        <div class="flex flex-col gap-5 pr-20">
                            <div class="flex flex-wrap gap-3">
                                <span class="badge-maroon px-5 py-1.5 text-sm rounded-full shadow-md font-bold">ปีงบฯ ${item.year}</span>
                                ${item.tci ? `<span class="badge-gold px-5 py-1.5 text-sm rounded-full shadow-md font-bold text-law-maroon-deep">${item.tci}</span>` : ''}
                            </div>
                            
                            <h3 class="text-2xl font-bold text-gray-800 leading-snug group-hover:text-law-maroon transition-colors">${item.title}</h3>
                            
                            <div class="p-5 bg-stone-50 rounded-2xl border-l-8 border-law-gold shadow-sm">
                                <div class="mb-3">
                                    <p class="text-lg flex items-center gap-3">
                                        <span class="font-extrabold text-law-maroon uppercase tracking-widest text-xs py-1 px-2 bg-red-100 rounded">ผู้วิจัย</span>
                                        <span class="font-bold text-blue-700 hover:underline decoration-2" onclick="event.stopPropagation(); openAuthorProjects('${head}')">${head}</span>
                                    </p>
                                </div>
                                ${coAuthors.length > 0 ? `
                                <div class="pt-2 border-t border-gray-200">
                                    <p class="text-sm flex items-center gap-3">
                                        <span class="font-bold text-gray-400 uppercase tracking-widest text-[10px]">ผู้ร่วมวิจัย</span>
                                        <span class="flex flex-wrap gap-2 text-gray-600 font-semibold">
                                            ${coAuthors.map(name => `<span class="hover:text-law-maroon cursor-pointer hover:underline" onclick="event.stopPropagation(); openAuthorProjects('${name}')">${name}</span>`).join('<span class="text-gray-300">|</span>')}
                                        </span>
                                    </p>
                                </div>` : ''} 
                            </div>

                            <div class="flex items-center justify-between mt-2 pt-4 border-t border-gray-100">
                                <div class="flex items-center gap-3 text-green-700 font-black text-xl">
                                    <i data-lucide="coins" class="w-6 h-6"></i>
                                    <span>${item.budget ? Number(item.budget).toLocaleString() + ' บาท' : 'ไม่มีงบประมาณ'}</span>
                                </div>
                                ${item.fileLink ? `
                                <a href="${item.fileLink}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center gap-3 px-8 py-3 bg-gradient-to-r from-law-maroon to-law-maroon-deep text-white rounded-full hover:shadow-xl hover:shadow-red-200 transition-all font-bold">
                                    <i data-lucide="download-cloud" class="w-5 h-5 text-law-gold-bright"></i> ดาวน์โหลดผลงาน
                                </a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
            lucide.createIcons();
        }

        function updateSummary(data) {
            const container = document.getElementById('summaryDashboard');
            if (!container) return;
            const counts = data.reduce((acc, item) => { acc[item.year] = (acc[item.year] || 0) + 1; return acc; }, {});
            const sortedYears = Object.keys(counts).sort((a, b) => b - a);
            
            let html = `
                <div class="bg-gradient-to-br from-law-maroon-deep to-law-maroon text-white p-8 rounded-[2.5rem] shadow-2xl border-b-8 border-law-gold transform hover:scale-105 transition-all">
                    <div class="flex justify-between items-center">
                        <div>
                             <p class="text-sm opacity-80 uppercase tracking-[0.2em] font-black mb-2">ผลงานทั้งหมดในคลัง</p>
                             <p class="text-5xl font-black">${data.length} <span class="text-2xl font-medium opacity-60">เรื่อง</span></p>
                        </div>
                        <div class="p-5 bg-white/20 rounded-3xl backdrop-blur-md"><i data-lucide="folder-kanban" class="w-12 h-12 text-law-gold-bright"></i></div>
                    </div>
                </div>`;
            
            sortedYears.slice(0, 3).forEach(year => {
                html += `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-2 border-gray-100 hover:border-law-gold transition-all group">
                    <p class="text-sm text-gray-400 uppercase tracking-widest font-black mb-3 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-law-gold"></i> ปีงบประมาณ ${year}
                    </p>
                    <p class="text-4xl font-black text-law-maroon group-hover:scale-110 transition-transform origin-left">${counts[year]} <span class="text-xl font-bold text-gray-300">เรื่อง</span></p>
                </div>`;
            });
            container.innerHTML = html;
            lucide.createIcons();
        }

        function openViewModal(index) {
            const item = db[index];
            const authors = item.author.split('||');
            document.getElementById('viewTitle').innerText = item.title;
            document.getElementById('viewYearBadge').innerText = "ปีงบประมาณ " + item.year;
            
            let authorsHTML = `
                <div class="mb-6 pb-6 border-b-2 border-dashed border-red-100">
                    <p class="text-xs text-law-gold font-black uppercase tracking-widest mb-2">ผู้วิจัยหลัก</p>
                    <p class="text-3xl font-black text-law-maroon-deep">${authors[0]}</p>
                </div>`;
            if(authors[1]) {
                authorsHTML += `
                <div>
                    <p class="text-xs text-gray-400 font-black uppercase tracking-widest mb-3">ผู้ร่วมวิจัย</p>
                    <p class="text-xl font-bold text-gray-700 leading-relaxed">${authors[1]}</p>
                </div>`;
            }
            document.getElementById('viewAuthorsDetail').innerHTML = authorsHTML;
            document.getElementById('viewBudget').innerText = item.budget ? Number(item.budget).toLocaleString() + " บาท" : "-";
            document.getElementById('viewTci').innerText = item.tci || "-";
            document.getElementById('viewModal').style.display = 'flex';
            lucide.createIcons();
        }

        async function saveNewData() {
            const title = document.getElementById('addTitle').value;
            const headAuthor = document.getElementById('addHeadAuthor').value;
            const fileInput = document.getElementById('addFile');
            if(!title || !headAuthor) { alert("กรุณาระบุหัวข้อวิจัยและผู้วิจัยหลัก"); return; }
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="flex items-center gap-2"><div class="w-5 h-5 border-4 border-white border-t-transparent animate-spin rounded-full"></div> กำลังบันทึก...</div>';

            let fileData = { base64: null, name: null, type: null };
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                const promise = new Promise((resolve) => {
                    reader.onload = () => {
                        fileData.base64 = reader.result.split(',')[1];
                        fileData.name = file.name;
                        fileData.type = file.type;
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
                await promise;
            }

            const payload = {
                action: isEditMode ? 'update' : 'add',
                index: editIndex,
                year: document.getElementById('addYear').value,
                title: title,
                author: headAuthor + "||" + document.getElementById('addCoAuthor').value,
                tci: document.getElementById('addTci').value,
                budget: document.getElementById('addBudget').value,
                fileBase64: fileData.base64,
                fileName: fileData.name,
                fileType: fileData.type
            };

            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("บันทึกเรียบร้อย!");
                location.reload();
            } catch (e) {
                alert("เกิดข้อผิดพลาด");
                btn.disabled = false;
                btn.innerHTML = 'บันทึกข้อมูล';
            }
        }
        
        function editItem(index) {
            const item = db[index];
            isEditMode = true;
            editIndex = index;
            const authors = item.author.split('||');
            document.getElementById('addTitle').value = item.title;
            document.getElementById('addHeadAuthor').value = authors[0];
            document.getElementById('addCoAuthor').value = authors[1] || "";
            document.getElementById('addYear').value = item.year;
            document.getElementById('addBudget').value = item.budget;
            document.getElementById('addTci').value = item.tci || "";
            document.getElementById('saveBtn').innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i> ยืนยันการแก้ไข';
            document.getElementById('addModal').style.display = 'flex';
            lucide.createIcons();
        }

        async function deleteItem(title, index) {
            if(!confirm(`⚠️ คุณต้องการลบโครงการ "${title}" ใช่หรือไม่?`)) return;
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', index: index }) });
                db.splice(index, 1);
                renderData();
                alert("ลบสำเร็จ");
            } catch(e) { alert("ลบไม่สำเร็จ"); }
        }

        function filterData() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const y = document.getElementById('yearFilter').value;
            const filtered = db.filter(i => (i.title.toLowerCase().includes(q) || i.author.toLowerCase().includes(q)) && (y === "" || i.year.toString() === y));
            renderData(filtered);
        }

        function openAuthorProjects(name) {
            const targetName = name.trim();
            if(!targetName || targetName === 'ไม่ระบุ' || targetName === 'null') return;

            // กรองข้อมูลเฉพาะของคนนั้น
            const personWorks = db.filter(item => item.author.includes(targetName)).sort((a, b) => b.year - a.year);
            
            const nameDisplay = document.getElementById('displayAuthorName');
            const listContainer = document.getElementById('authorProjectsList');
            
            nameDisplay.innerText = targetName;
            listContainer.innerHTML = ''; // ล้างค่าเก่า

            if(personWorks.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-10 opacity-50">ไม่พบประวัติผลงานเพิ่มเติม</div>';
            } else {
                personWorks.forEach(work => {
                    // เช็คว่าเป็นผู้วิจัยหลักหรือร่วม
                    const isPrincipal = work.author.split('||')[0].trim() === targetName;
                    
                    const workHtml = `
                        <div class="bg-white rounded-3xl p-6 mb-4 shadow-sm border-l-[6px] border-purple-500 relative group transition-all hover:shadow-md">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[11px] font-bold py-1 px-3 rounded-full bg-purple-50 text-purple-600 border border-purple-100">
                                    ปี ${work.year} • โครงการวิจัย
                                </span>
                                <div class="text-gray-300 text-[11px]">
                                    ${work.fileLink ? 
                                        `<a href="${work.fileLink}" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> ดาวน์โหลด</a>` 
                                        : 'ไม่มีไฟล์'}
                                </div>
                            </div>
                            
                            <h4 class="text-lg font-bold text-gray-800 leading-snug mb-3">${work.title}</h4>
                            
                            <div class="flex items-center gap-2 text-gray-500 text-xs">
                                <i data-lucide="landmark" class="w-4 h-4"></i>
                                <span>${work.fund || 'ไม่ระบุแหล่งทุน'}</span>
                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', workHtml);
                });
            }

    // เปิด Modal และปิด Modal อื่นที่ซ้อนอยู่
    if(document.getElementById('viewModal')) document.getElementById('viewModal').style.display = 'none';
    document.getElementById('authorProjectsModal').style.display = 'flex';
    lucide.createIcons(); // อัปเดตไอคอน
}
        
    </script>

   <div id="authorProjectsModal" class="modal px-4" style="display:none; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
    <div class="bg-stone-50 rounded-[2.5rem] w-full max-w-2xl overflow-hidden shadow-2xl flex flex-col animate__animated animate__zoomIn animate__faster">
        
        <div class="bg-[#600000] p-8 relative flex items-center gap-5 border-b-4 border-law-gold">
            <div class="w-20 h-20 bg-white rounded-full flex-shrink-0 border-4 border-white/20 flex items-center justify-center shadow-lg">
                <i data-lucide="user" class="w-10 h-10 text-[#600000]"></i>
            </div>
            
            <div class="flex-grow">
                <h3 id="displayAuthorName" class="text-2xl font-bold text-white mb-1">ชื่อผู้วิจัย</h3>
                <p class="text-white/70 text-sm">สรุปผลงานวิจัยและงานตีพิมพ์รายบุคคล</p>
            </div>

            <button onclick="closeModal('authorProjectsModal')" class="absolute top-6 right-6 w-10 h-10 bg-black/20 hover:bg-black/40 text-white rounded-full flex items-center justify-center transition-all">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div id="authorProjectsList" class="p-6 overflow-y-auto max-h-[60vh] bg-stone-100">
            </div>

        <div class="p-4 bg-white text-center border-t border-gray-100">
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Faculty of Law Database System</p>
        </div>
    </div>
</div>
</body>
</html>
